# CLAUDE.md

Dify项目Claude Code开发指南

## 项目概述

Dify是一个开源LLM应用开发平台，结合AI工作流、RAG管道、智能体能力和模型管理。

项目结构：
- **后端API** (`/api`): Python Flask应用，领域驱动设计架构
- **前端Web** (`/web`): Next.js 15 + TypeScript + React 19
- **Docker部署** (`/docker`): 容器化部署配置

## 开发命令

### 后端API

Python命令需要前缀 `uv run --project api`:

```bash
# 启动开发服务器
./dev/start-api                   # 启动API服务器
./dev/start-worker                # 启动Celery工作器

# 运行测试
uv run --project api pytest      # 运行所有测试

# 代码质量检查
./dev/reformat                    # 运行所有格式化和检查工具
```

### 前端Web

```bash
cd web
pnpm lint                         # ESLint检查
pnpm eslint-fix                   # 修复ESLint问题
pnpm test                         # Jest测试
```

## 核心开发原则

### 1. **功能完整性**
- **100%功能对等**: 重构时确保零功能丢失
- **不要冗余功能**: 移除不必要的抽象、默认值和模拟数据
- **不要遗漏功能**: 保持与原始实现的完整功能兼容
- **失败即抛异常**: 不要用默认返回值掩盖失败，让异常向上抛出

### 2. **代码架构**
- **避免过度设计**: 不要创建不必要的"引擎"、"管理器"或抽象层
- **功能直接实现**: 适当时在主控制器中直接实现功能
- **模块化但不过度抽象**: 将代码组织成模块但避免不必要的抽象层
- **保持简单**: 简单直接的实现往往比过度工程化的解决方案更好

### 3. **JSON处理规范**
- **通用JSON提取器**: 创建可重用的JSON解析工具类
- **统一错误处理**: JSON解析失败时抛出具体异常，不返回默认值
- **类型验证**: 验证JSON数据结构和必需字段
- **清晰的错误信息**: 提供明确的解析失败原因

### 4. **错误处理**
- **不要默认数据**: 真实数据失败时绝不返回默认/模拟数据
- **不要掩盖错误**: 不要静默处理错误，让错误显露出来
- **快速失败**: 快速失败并提供清晰的错误信息
- **异常优于默认值**: 抛出异常而不是返回占位符值

### 5. **数据处理**
- **真实数据流**: 确保数据流完全按照原始系统进行
- **格式化精确**: 精确匹配原始数据格式要求
- **计算准确**: 技术指标和计算必须完全相同
- **智能缓存**: 实现带依赖跟踪的智能缓存

## 代码风格要求

### Python代码
- **类型提示**: 所有函数和类属性使用类型提示
- **避免Any类型**: 除非绝对必要，不使用Any类型
- **实现特殊方法**: 适当实现`__repr__`、`__str__`等特殊方法

### 变量命名
- **简单英文名**: 使用`price`、`volume`、`data`、`result`等简单名称
- **避免长描述性名称**: 不使用`comprehensive_market_data_collection_result`
- **直观易懂**: 代码应该对任何开发者都易读
- **不要缩写**: 使用`price`而不是`prc`，`data`而不是`dt`

## 金融数据处理规则

### 数据准确性
- **真实数据优先**: 只使用来自验证来源的真实数据
- **不要虚构数据**: 绝不创建假的估算或任意乘以真实数据
- **明确标注估算**: 如果需要估算，清楚标记为估算
- **数据来源透明**: 始终指定数据来源及其限制

### 财务数据完整性
- **不要估算周/月数据**: 绝不将日数据乘以7或30来估算周/月数据
- **显示实际可得数据**: 只显示实际可用的数据
- **API限制要说明**: 清楚说明何时因API限制而无数据
- **错误要明确报告**: 明确报告数据收集失败

## 加密货币监控配置规则

### 配置文件管理
- **主配置文件**: `crypto_monitor_config.yaml`
- **配置驱动开发**: 所有重要变量、参数和设置必须存储在YAML文件中
- **代码中禁止硬编码**: 绝不在Python代码中硬编码加密货币符号、间隔、阈值或任何业务参数
- **动态配置加载**: 代码应在运行时读取配置并尊重更改

### 配置使用要求
```python
# ✅ 正确 - 从配置读取
major_symbols = self.settings.monitor.primary_symbols + self.settings.monitor.secondary_symbols

# ❌ 错误 - 硬编码值
major_symbols = ['BTCUSDT', 'ETHUSDT', 'SOLUSDT']  # 不要这样做！
```

## Dify工作流DSL开发规则

### DSL文件格式规范
- **基本结构**: 遵循YAML格式，包含app和workflow部分
- **节点配置**: 所有节点ID必须是字符串格式（用引号包围）
- **变量引用**: 使用正确语法`{{#node_id.variable_name#}}`
- **边连接**: 正确连接所有节点，确保工作流完整

### 提示词模板规范
- **系统提示词**: 存储在独立的.txt文件中，完整无变量
- **用户消息**: 在脚本中组装，支持占位符变量替换
- **JSON输出**: 严格按照指定的JSON格式输出
- **错误处理**: JSON解析失败时抛出异常而不是返回默认值

## 重要注意事项

### 禁止事项
- ❌ 创建"华尔街引擎"或类似不必要的命名抽象
- ❌ 当真实数据不可用时返回默认/模拟数据
- ❌ 创建未在原始代码中存在的新抽象
- ❌ 在存在提示文件时使用硬编码提示
- ❌ 掩盖异常返回默认值

### 必须事项
- ✅ 完全理解原始代码架构再重构
- ✅ 使用通用JSON提取器处理API响应
- ✅ 让错误显式失败而不是默认返回
- ✅ 保持代码简单直接
- ✅ 在适当时抛出异常

## 质量检查清单

重构前必须：
1. **完整分析原始代码**: 读取并理解完整的原始实现
2. **识别所有功能点**: 列出每个功能、方法和能力
3. **理解数据流**: 映射从输入到输出的完整数据流
4. **检查依赖关系**: 理解所有依赖和缓存机制
5. **验证配置使用**: 确保所有配置参数得到保留

代码提交前必须：
- [ ] 所有功能与原始版本完全相同
- [ ] 所有数据处理产生相同结果
- [ ] 错误情况以与原始相同的方式失败
- [ ] 性能特征得到维护或改进
- [ ] JSON解析使用通用提取器
- [ ] 无硬编码的业务参数